<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UDIP—FA Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Increase this to make the embedded brain viewer larger */
      --viewerBoxHeight: 420px; /* e.g., 520/560/620 or clamp(520px, 60vh, 760px) */
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family:'Roboto',sans-serif; background:#f5f7fa; color:#333;
      height:100vh; display:flex; flex-direction:column;
    }
    /* Header with logo + controls */
    header{
      background:#fff; padding:10px 16px; box-shadow:0 2px 4px rgba(0,0,0,0.1);
      display:flex; align-items:center; gap:16px; justify-content:space-between;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    header img{ height:50px; object-fit:contain; }
    .controls{ display:flex; align-items:center; gap:8px; }
    .controls label{ font-size:14px; color:#444; }
    .controls select{
      padding:10px; font-size:14px; border:1px solid #ccd0d5; border-radius:4px; appearance:none;
      background:
        url('data:image/svg+xml;utf8,<svg fill="%23666" height="12" viewBox="0 0 24 24" width="12" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>')
        no-repeat right 12px center #fff;
      background-size:12px; cursor:pointer; box-shadow:inset 0 1px 3px rgba(0,0,0,0.05);
    }

    /* Main panel (full width) */
    #main-panel{
      flex:1; display:flex; flex-direction:column; background:#fff;
      margin:16px; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow:hidden;
    }

    /* Top: viewer that auto-fits without scrollbars */
    #viewer-container{
      height:var(--viewerBoxHeight);
      border-bottom:1px solid #e0e0e0; overflow:hidden; position:relative; background:#fff;
    }
    #viewer-scale{ position:absolute; left:0; top:0; transform-origin:top left; }
    #mask-viewer{ width:100%; height:100%; border:none; display:block; }

    /* Bottom: CSV table */
    #table-container{ flex:1; overflow:auto; padding:12px; background:#fafafa; }
    #table-container table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums; }
    #table-container th, #table-container td{ border:1px solid #ddd; padding:8px 10px; font-size:12px; }
    #table-container th{ background:#f1f1f1; font-weight:500; position:sticky; top:0; z-index:1; }
    #table-container tbody tr:nth-child(even){ background:#fcfcfc; }
    #table-container td{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    footer{
      background:#fff; padding:10px 16px; font-size:12px; color:#666; text-align:center;
      border-top:1px solid #e0e0e0; box-shadow:0 -2px 4px rgba(0,0,0,0.05);
    }
    footer a{ color:#007acc; text-decoration:none; }
    footer a:hover{ text-decoration:underline; }

    @media (max-width: 900px){
      #main-panel{ margin:10px; }
      .controls{ flex-wrap:wrap; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="logo-horizontal.png" alt="UTHealth Houston – McWilliams School Logo">
    </div>
    <div class="controls">
      <label for="mask-select">Select a dimension:</label>
      <select id="mask-select">
        <option value="">-- choose a mask --</option>
      </select>
    </div>
  </header>

  <div id="main-panel">
    <div id="viewer-container">
      <div id="viewer-scale">
        <iframe id="mask-viewer" name="maskFrame" src="" allowfullscreen></iframe>
      </div>
    </div>
    <div id="table-container"></div>
  </div>

  <footer>
    Unveiling genetic architecture of white matter microstructure through unsupervised deep representation learning of fractional anisotropy images<br>
    Xingzhong Zhao, Ziqian Xie, Wei He, Myriam Fornage, Degui Zhi<br>
    medRxiv 2025.07.04.25330856; doi:
    <a href="https://doi.org/10.1101/2025.07.04.25330856" target="_blank">10.1101/2025.07.04.25330856</a>
  </footer>

  <script>
    /* Paths */
    const htmlBase = '3d_html_masks';
    const csvBase  = 'WM_stat';

    /* Dropdown options: label shown (Dim1..), value used (Dim_0.. for files) */
    const masks = Array.from({ length: 128 }, (_, i) => ({ label: `Dim${i + 1}`, value: `Dim_${i}` }));

    const selectEl = document.getElementById('mask-select');
    const maskFrame = document.getElementById('mask-viewer');
    const scaleWrapper = document.getElementById('viewer-scale');
    const viewerBox = document.getElementById('viewer-container');
    const tableContainer = document.getElementById('table-container');

    masks.forEach(({ label, value }) => {
      const opt = document.createElement('option');
      opt.value = value; opt.textContent = label;
      selectEl.appendChild(opt);
    });

    const DISPLAY_HEADER = ['WM tracts', 'Abbreviation', 'observed T value', 'P value'];

    function renderTable(rows){
      const tbl=document.createElement('table');
      const thead=tbl.createTHead().insertRow();
      rows[0].forEach(c=>{ const th=document.createElement('th'); th.textContent=c; thead.appendChild(th); });
      const tbody=tbl.createTBody();
      rows.slice(1).forEach(r=>{ const tr=tbody.insertRow(); r.forEach(c=>{ const td=tr.insertCell(); td.textContent=c; }); });
      tableContainer.innerHTML=''; tableContainer.appendChild(tbl);
    }

    // Fit the embedded page into the visible box without scrollbars (same-origin)
    function fitEmbeddedViewer(){
      try{
        const doc = maskFrame.contentDocument || maskFrame.contentWindow?.document;
        if(!doc) return;
        const el = doc.documentElement, body = doc.body;
        const contentW = Math.max(el.scrollWidth, el.offsetWidth, el.clientWidth,
                                  body?.scrollWidth||0, body?.offsetWidth||0, body?.clientWidth||0);
        const contentH = Math.max(el.scrollHeight, el.offsetHeight, el.clientHeight,
                                  body?.scrollHeight||0, body?.offsetHeight||0, body?.clientHeight||0);
        const boxW = viewerBox.clientWidth, boxH = viewerBox.clientHeight;
        const scale = Math.min(boxW/contentW, boxH/contentH, 1);  // fit both dimensions

        scaleWrapper.style.width = contentW+'px';
        scaleWrapper.style.height = contentH+'px';
        scaleWrapper.style.transform = `scale(${scale})`;

        if(body){ body.style.overflow='hidden'; }
        el.style.overflow='hidden';

        // Optionally hide controls inside the embedded page
        doc.querySelectorAll('select, .papaya-toolbar, #papayaToolbar, .papayaMenu, .papaya-control')
           .forEach(n => n.style.display = 'none');
      }catch(e){
        console.warn('fitEmbeddedViewer skipped (cross-origin):', e);
      }
    }

    selectEl.addEventListener('change', async (e)=>{
      const name=e.target.value;
      if(!name){ maskFrame.src=''; tableContainer.innerHTML=''; return; }

      maskFrame.onload = ()=>{
        fitEmbeddedViewer();
        setTimeout(fitEmbeddedViewer, 150);
        setTimeout(fitEmbeddedViewer, 400);
      };
      maskFrame.src = `${htmlBase}/${name}.html`;

      tableContainer.textContent='Loading CSV…';
      try{
        const resp=await fetch(`${csvBase}/${name}.csv`);
        if(!resp.ok) throw new Error(`CSV ${name} not found (${resp.status})`);
        let text=(await resp.text()).replace(/^\uFEFF/,'');
        const rows=text.trim().split(/\r?\n/).map(l=>l.split(','));
        if(!rows.length || !rows[0].length){ tableContainer.textContent='CSV is empty or malformed.'; return; }
        const looksHeader=/[A-Za-z]/.test(rows[0].join(''));
        if(looksHeader) rows[0]=DISPLAY_HEADER.slice(0, rows[0].length);
        else rows.unshift(DISPLAY_HEADER.slice(0, rows[0].length || DISPLAY_HEADER.length));
        renderTable(rows);
      }catch(err){
        console.error(err);
        tableContainer.textContent='Unable to load CSV data.';
      }
    });

    window.addEventListener('resize', ()=> setTimeout(fitEmbeddedViewer, 50));

    // Auto-select first item
    selectEl.value = masks[0].value;
    selectEl.dispatchEvent(new Event('change'));
  </script>
</body>
</html>
